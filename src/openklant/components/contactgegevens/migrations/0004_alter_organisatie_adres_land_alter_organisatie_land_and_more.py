# Generated by Django 4.2.15 on 2025-01-09 15:19
import logging
import django.core.validators
from django.db import migrations, models
import openklant.utils.validators
from django.db import IntegrityError

from openklant.utils.constants import COUNTRIES_DICT

logger = logging.getLogger(__name__)

FIELDS = ["adres_land", "land"]


def _check_records(records):
    total_failed_records = 0
    for record in records:
        record_failed = False
        for field_name in FIELDS:
            field_value = getattr(record, field_name, None)
            iso_code = COUNTRIES_DICT.get(field_value, "")
            if field_value and not iso_code:
                record_failed = True
                logger.warning(
                    "%s(pk=%s, uuid=%s) Field: '%s'. No match found for nl_code (not found in Tabel 34 Landentabel): '%s'",
                    type(record).__qualname__,
                    record.pk,
                    record.uuid,
                    field_name,
                    field_value,
                )

        if record_failed:
            total_failed_records += 1
    return total_failed_records


def _update_records(records):
    for record in records:
        updated = False
        for field_name in FIELDS:
            if field_value := getattr(record, field_name, None):
                iso_code = COUNTRIES_DICT.get(field_value, "")
                setattr(record, field_name, iso_code)
                updated = True

        if updated:
            record.save()


def _check_and_update_records(apps, schema_editor):
    Organisatie = apps.get_model("contactgegevens", "Organisatie")
    Persoon = apps.get_model("contactgegevens", "Persoon")

    for model in [Organisatie, Persoon]:
        records = model.objects.all()
        if total_failed_records := _check_records(records):
            raise IntegrityError(
                "The migration cannot proceed due to %s records that don't comply with the %s model's requirements. "
                "Possible data inconsistency or mapping error."
                % (total_failed_records, model.__qualname__)
            )
        else:
            _update_records(records)


class Migration(migrations.Migration):

    dependencies = [
        ("contactgegevens", "0003_alter_persoon_overlijdensdatum"),
    ]

    operations = [
        migrations.RunPython(
            code=_check_and_update_records,
            reverse_code=migrations.RunPython.noop,
        ),
        migrations.AlterField(
            model_name="organisatie",
            name="adres_land",
            field=models.CharField(
                blank=True,
                help_text="ISO 3166-code die het land (buiten Nederland) aangeeft alwaar de ingeschrevene verblijft.",
                max_length=2,
                validators=[
                    django.core.validators.MinLengthValidator(limit_value=2),
                    openklant.utils.validators.validate_country,
                ],
                verbose_name="land",
            ),
        ),
        migrations.AlterField(
            model_name="organisatie",
            name="land",
            field=models.CharField(
                blank=True,
                help_text="ISO 3166-code die het land (buiten Nederland) aangeeft alwaar de ingeschrevene verblijft.",
                max_length=2,
                validators=[
                    django.core.validators.MinLengthValidator(limit_value=2),
                    openklant.utils.validators.validate_country,
                ],
                verbose_name="land",
            ),
        ),
        migrations.AlterField(
            model_name="persoon",
            name="adres_land",
            field=models.CharField(
                blank=True,
                help_text="ISO 3166-code die het land (buiten Nederland) aangeeft alwaar de ingeschrevene verblijft.",
                max_length=2,
                validators=[
                    django.core.validators.MinLengthValidator(limit_value=2),
                    openklant.utils.validators.validate_country,
                ],
                verbose_name="land",
            ),
        ),
        migrations.AlterField(
            model_name="persoon",
            name="land",
            field=models.CharField(
                blank=True,
                help_text="ISO 3166-code die het land (buiten Nederland) aangeeft alwaar de ingeschrevene verblijft.",
                max_length=2,
                validators=[
                    django.core.validators.MinLengthValidator(limit_value=2),
                    openklant.utils.validators.validate_country,
                ],
                verbose_name="land",
            ),
        ),
    ]
